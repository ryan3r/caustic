stages:
  - test
  - upload

SpringTest:
  stage: test
  tags:
    - docker
  image: openjdk:13-jdk-alpine
  artifacts:
    expire_in: 1 week
    reports:
      junit: caustic/target/surefire-reports/*.xml
  script:
    - cd caustic
    - sed 's/localhost/cs319-105.misc.iastate.edu/' -i src/main/resources/application.properties
    - sed 's/root/caustic/' -i src/main/resources/application.properties
    - ./mvnw test
  except:
    - /-runner$/

RunnerTest:
  stage: test
  tags:
    - docker
  image: ryan3r/caustic-runner
  artifacts:
    expire_in: 1 week
    reports:
      junit: /go/src/runner/report.xml
  before_script:
    - apk add --no-cache git
    - go get -u github.com/jstemmer/go-junit-report
  script:
    - cp -r runner/runner /go/src
    - cd /go/src/runner
    - go test -v 2>&1 | tee >(go-junit-report > report.xml)
  only:
    - master
    - /-runner$/

DockerUpload:
  stage: upload
  when: manual
  tags:
    - shell
  script:
    - sudo upload-to-docker
  only:
    - master
